(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[41],{6975:function(e,s,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/getting-started/integration-tests",function(){return n(2368)}])},1893:function(e,s,n){"use strict";n.d(s,{Z:function(){return x}});var r=n(5893);n(7294);var t=n(5675),o=n.n(t),l={src:"/_next/static/media/atlas-logo-light-mode.6077cdd3.svg",height:320,width:937,blurWidth:0,blurHeight:0},i={src:"/_next/static/media/atlas-logo-dark-mode.62b4f6dd.svg",height:320,width:945,blurWidth:0,blurHeight:0},a=n(2010);let c=()=>{let{resolvedTheme:e}=(0,a.F)();return(0,r.jsx)(o(),{src:"light"===e?l:i,alt:"Atlas Logo",height:"42"})};var h=n(1163);let d={logo:(0,r.jsx)(c,{}),project:{link:"https://github.com/geniusyield/atlas-docs"},chat:{link:"https://discord.gg/TNHf4fs626"},docsRepositoryBase:"https://github.com/geniusyield/atlas-docs/tree/main",useNextSeoProps(){let{asPath:e}=(0,h.useRouter)(),s="All-in-one solution for writing off-chain code for Plutus contracts";return{titleTemplate:"/"===e?"ATLAS Plutus Application Backend | by Genius Yield":"Atlas | %s",description:s,canonical:"https://atlas-app.io",openGraph:{url:"https://atlas-app.io",description:s,images:[{url:"/open-graph.png",width:1200,height:630,alt:"Atlas - Application backend for Plutus smart contracts on Cardano",type:"image/png"}]},siteName:"Atlas",twitter:{handle:"@GeniusyieldO",site:"https://www.geniusyield.co",cardType:"summary_large_image"}}},head:(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("link",{rel:"apple-touch-icon",sizes:"180x180",href:"/favicon/apple-touch-icon.png"}),(0,r.jsx)("link",{rel:"icon",type:"image/png",sizes:"32x32",href:"/favicon/favicon-32x32.png"}),(0,r.jsx)("link",{rel:"icon",type:"image/png",sizes:"16x16",href:"/favicon/favicon-16x16.png"}),(0,r.jsx)("link",{rel:"manifest",href:"/favicon/site.webmanifest"}),(0,r.jsx)("link",{rel:"mask-icon",href:"/favicon/safari-pinned-tab.svg",color:"#5bbad5"}),(0,r.jsx)("link",{rel:"shortcut icon",href:"/favicon/favicon.ico"}),(0,r.jsx)("meta",{name:"msapplication-TileColor",content:"#da532c"}),(0,r.jsx)("meta",{name:"msapplication-config",content:"/favicon/browserconfig.xml"}),(0,r.jsx)("meta",{name:"theme-color",content:"#ffffff"})]}),footer:{component:(0,r.jsx)(r.Fragment,{})},sidebar:{toggleButton:!0}};var x=d},2368:function(e,s,n){"use strict";n.r(s),n.d(s,{default:function(){return a.Z}});var r=n(5893),t=n(8808),o=n(4783),l=n(1893);n(9966);var i=n(1151);n(5675);var a=n(2243);function c(e){let s=Object.assign({h1:"h1",p:"p",em:"em",table:"table",thead:"thead",tr:"tr",th:"th",strong:"strong",tbody:"tbody",td:"td",h2:"h2",a:"a",code:"code",ol:"ol",li:"li",sup:"sup",ul:"ul",pre:"pre",span:"span",section:"section"},(0,i.ah)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.h1,{children:"Integration Tests"}),"\n",(0,r.jsxs)(s.p,{children:["We already saw how we can conveniently write tests for our smart contract using our wrapper upon Plutus simple model. But these tests were running against a mock ledger, i.e., we really were just simulating it by having some mock data-structures (say set of UTxOs) which were getting updated on submission of successful transaction. We could however write tests to test against the real node and have it slightly more convenient to program against by spinning up our own private network (",(0,r.jsx)(s.em,{children:"privnet"})," for short). Here is the table which outlines the differences between the two approaches:"]}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:(0,r.jsx)(s.strong,{children:"Tests using PSM Wrapper"})}),(0,r.jsx)(s.th,{children:(0,r.jsx)(s.strong,{children:"Tests using Private Network"})})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Runs against mock ledger"}),(0,r.jsx)(s.td,{children:"Runs against real node"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Each unit test gets fresh set of wallets (having original balance)"}),(0,r.jsx)(s.td,{children:"Each subsequent unit test continues upon the effects caused by previous ones"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Fast, purer & convenient"}),(0,r.jsx)(s.td,{children:"Slow as each slot is 0.1 second"})]})]})]}),"\n",(0,r.jsx)(s.p,{children:"Thus these tests are suitable for integration testing."}),"\n",(0,r.jsx)(s.h2,{id:"spinning-up-private-network",children:"Spinning up private network"}),"\n",(0,r.jsxs)(s.p,{children:["Our private network is adapted from WoofPool's ",(0,r.jsx)(s.a,{href:"https://github.com/woofpool/cardano-private-testnet-setup",children:(0,r.jsx)(s.code,{children:"cardano-private-testnet-setup"})})," repository."]}),"\n",(0,r.jsx)(s.p,{children:"To spin up it up:"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["Clone ",(0,r.jsx)(s.a,{href:"https://github.com/geniusyield/cardano-private-testnet-setup",children:"this"})," repository. Make sure to not clone it in some deep nested path as then the path length towards the generated socket file (",(0,r.jsx)(s.code,{children:"node.sock"}),") may exceed 108 characters",(0,r.jsx)(s.sup,{children:(0,r.jsx)(s.a,{href:"#user-content-fn-5",id:"user-content-fnref-5","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"1"})}),"."]}),"\n",(0,r.jsxs)(s.li,{children:["Enter it & checkout ",(0,r.jsx)(s.code,{children:"geniusyield"})," branch."]}),"\n",(0,r.jsxs)(s.li,{children:["Enter the following in terminal: ",(0,r.jsx)(s.code,{children:"./scripts/automate.sh"})," (you would need to have ",(0,r.jsx)(s.code,{children:"cardano-node"})," & ",(0,r.jsx)(s.code,{children:"cardano-cli"})," available in your ",(0,r.jsx)(s.code,{children:"PATH"}),")."]}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:['Once it says, "',(0,r.jsx)(s.em,{children:"Congrats! Your network is ready for use!"}),'" you can attempt to run the tests (in another terminal).']}),"\n",(0,r.jsxs)(s.p,{children:["First, let's say the path to ",(0,r.jsx)(s.code,{children:"private-testnet-simple"})," is ",(0,r.jsx)(s.code,{children:"X"}),", then being inside your example project folder, you can execute the tests by running ",(0,r.jsx)(s.code,{children:"GENIUSYIELD_PRIVNET_DIR=$X/private-testnet cabal run betref-privnet-tests -- -j1"})]}),"\n",(0,r.jsxs)(s.p,{children:["The ",(0,r.jsx)(s.code,{children:"-j1"})," is needed so that the tests run sequentially."]}),"\n",(0,r.jsx)(o.UW,{type:"info",children:(0,r.jsxs)(s.p,{children:["Remember to stop (",(0,r.jsx)(s.code,{children:"CTRL-C"}),", and ",(0,r.jsx)(s.code,{children:"killall cardano-node"}),") the private testnet, or it will eventually eat all of your disk space."]})}),"\n",(0,r.jsx)(s.p,{children:"The way we have it setup for our test boilerplate is that we have three users where second and third user have the following balances:"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"5 UTxOs each containing thousand ada"}),"\n",(0,r.jsx)(s.li,{children:"1 million each of gold & iron tokens"}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:'"User 1" UTxOs list isn\'t that clean but does include 5 UTxOs each containing roughly thousand ada plus some other UTxOs containing a lot more ada. Also User 1 has 3 million each of gold & iron tokens.'}),"\n",(0,r.jsx)(s.p,{children:"We'll see how to create a new user soon."}),"\n",(0,r.jsx)(o.UW,{type:"warning",children:(0,r.jsxs)(s.p,{children:["Unless you kill & restart the private network, running your privnet tests again, would have them run in the modified network state. So in general, if you wish to reexecute the command mentioned before, viz. ",(0,r.jsx)(s.code,{children:"ATLAS_PRIVNET_DIR=$(pwd)/private-testnet-simple/private-testnet cabal run privnet-tests -- -j1"}),", you should first restart the privnet",(0,r.jsx)(s.sup,{children:(0,r.jsx)(s.a,{href:"#user-content-fn-1",id:"user-content-fnref-1","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"2"})}),"."]})}),"\n",(0,r.jsx)(s.h2,{id:"understanding-our-first-test",children:"Understanding our first test"}),"\n",(0,r.jsx)(o.UW,{type:"warning",emoji:"\uD83D\uDCC3",children:(0,r.jsxs)(s.p,{children:["The tests are written in ",(0,r.jsx)(s.a,{href:"https://github.com/geniusyield/atlas-examples/tree/main/bet-ref/tests-privnet/BetRef/Tests/Privnet/Tests.hs",children:"this"})," file and are being called ",(0,r.jsx)(s.a,{href:"https://github.com/geniusyield/atlas-examples/tree/main/bet-ref/tests-privnet/betref-privnet-tests.hs",children:"here"}),"."]})}),"\n",(0,r.jsx)(s.p,{children:"Here is the code (& explaination follows after it):"}),"\n",(0,r.jsx)(s.pre,{"data-language":"haskell","data-theme":"default",hasCopyCode:!0,children:(0,r.jsxs)(s.code,{"data-language":"haskell","data-theme":"default",children:[(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  testCaseSteps "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"Balance checks & taking pot by closest guesser should pass"'}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"$"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"\\"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"info "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"->"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" withSetup setup info "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"$"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"\\"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"ctx "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"->"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"do"})]}),"\n",(0,r.jsx)(s.span,{className:"line",children:" "}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"-- First step: Construct the parameters and obtain validator from it."})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"--"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"-- Let's define a new User to represent Oracle (not necessary though)"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    oracleUser "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"<-"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" newTempUserCtx ctx User1 (valueFromLovelace "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"20_000_000"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:")"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    (currentSlot"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" slotConfig) "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"<-"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" getSlotAndConfig ctx"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"let"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" betUntilSlotDelta "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"100"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        betRevealSlotDelta "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"200"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        betUntilTime "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" slotToBeginTimePure slotConfig (unsafeAdvanceSlot currentSlot betUntilSlotDelta)"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        betRevealTime "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" slotToBeginTimePure slotConfig (unsafeAdvanceSlot currentSlot betRevealSlotDelta)"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        brp "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" BetRefParams (pubKeyHashToPlutus "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"$"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" userPkh oracleUser) (timeToPlutus betUntilTime) (timeToPlutus betRevealTime) (valueToPlutus "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"$"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" valueFromLovelace "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"10_000_000"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:")"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        validator "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" betRefValidator' brp"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    validatorAddress "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"<-"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" ctxRunC ctx User1 "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"$"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" betRefAddress brp"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"-- Second step: Putting reference script for validator."})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    refScript "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"<-"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" addRefScriptCtx ctx User1 (validatorToScript validator)"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    threadDelay "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"1_000_000"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"-- Third step: Put some bets."})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"--"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"-- 1st bet."})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    txBodyLock "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"<-"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" ctxRunI ctx User1 "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"$"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" placeBet refScript brp (OracleAnswerDatum "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"1"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") (valueFromLovelace "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"10_000_000"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") (ctxUserAddr ctx User1) Nothing"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    lockedORef "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"<-"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" findOutput validatorAddress txBodyLock"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    void "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"$"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" submitTx ctx User1 txBodyLock"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    threadDelay "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"1_000_000"})]}),"\n",(0,r.jsx)(s.span,{className:"line",children:" "}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"--"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"-- 2nd bet."})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    txBodyLock "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"<-"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" ctxRunI ctx User2 "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"$"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" placeBet refScript brp (OracleAnswerDatum "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"2"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") (valueFromLovelace "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"20_000_000"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") (ctxUserAddr ctx User2) (Just lockedORef)"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    lockedORef "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"<-"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" findOutput validatorAddress txBodyLock"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    void "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"$"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" submitTx ctx User2 txBodyLock"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    threadDelay "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"1_000_000"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"--"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"-- 3rd bet."})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    txBodyLock "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"<-"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" ctxRunI ctx User1 "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"$"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" placeBet refScript brp (OracleAnswerDatum "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"3"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") (valueFromLovelace "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"35_000_000"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:") (ctxUserAddr ctx User1) (Just lockedORef)"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    lockedORef "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"<-"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" findOutput validatorAddress txBodyLock"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    void "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"$"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" submitTx ctx User1 txBodyLock"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    threadDelay "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"1_000_000"})]}),"\n",(0,r.jsx)(s.span,{className:"line",children:" "}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"-- Fourth step, get the bets pot."})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"--"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"-- Let's first wait for the required amount"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    ctxWaitUntilSlot ctx (unsafeAdvanceSlot currentSlot betRevealSlotDelta)  "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"-- here this `currentSlot` is what we obtained sometime ago, the actual current slot has certainly increased a lot by now."})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"--"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"-- Let's then add for the reference input"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    refInputORef "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"<-"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" addRefInputCtx ctx User1 True (userAddr oracleUser) (datumFromPlutusData (OracleAnswerDatum "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"2"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"))"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    threadDelay "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"1_000_000"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"--"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"-- Balance of `User2` before unlocking"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    balance "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"<-"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" ctxQueryBalance ctx User2"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"--"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"-- Unlock operation"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    txBodyUnlock "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"<-"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" ctxRunI ctx User2 "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"$"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" takeBets refScript brp lockedORef (ctxUserAddr ctx User2) refInputORef"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    void "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"$"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" submitTx ctx User2 txBodyUnlock"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    threadDelay "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"1_000_000"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"--"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"-- Balance of `User2` after unlocking"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    balance' "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"<-"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" ctxQueryBalance ctx User2"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"let"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" diff "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" valueMinus balance' balance"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        adaChange "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" fst "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"$"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" valueSplitAda diff  "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"-- should be withing [65 ada - max-fee, 65 ada)"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        adaExpectedIncrease "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"65_000_000"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        maxFee "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"1_000_000"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    assertBool "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"User2 ada increase must be b/w [adaExpectedIncrease - maxFee, adaExpectedIncrease)"'})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"         "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"$"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" adaExpectedIncrease "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"-"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" maxFee "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"<="}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" adaChange "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"&&"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" adaChange "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"<"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" adaExpectedIncrease"})]})]})}),"\n",(0,r.jsxs)(s.p,{children:["The first line ",(0,r.jsx)(s.code,{children:'testCaseSteps "test description" $ \\info -> withSetup setup info $ \\ctx -> do'})," can be seen as a boilerplate for all of your tests."]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"ctx"})," denotes the so called context (of type ",(0,r.jsx)(s.code,{children:"Ctx"}),") and contains information about our users, additional tokens, etc. It is defined in ",(0,r.jsx)(s.a,{href:"https://github.com/geniusyield/atlas/tree/main/src/GeniusYield/Test/Privnet/Ctx.hs",children:(0,r.jsx)(s.code,{children:"Ctx.hs"})})," file and it is essential to go over that file if you intend to write these tests."]}),"\n",(0,r.jsxs)(s.p,{children:["Variable ",(0,r.jsx)(s.code,{children:"info"})," is used to log messages and you can use it in your test's ",(0,r.jsx)(s.code,{children:"do"})," block like ",(0,r.jsx)(s.code,{children:'info $ printf "Hello from %s" "Atlas"'})]}),"\n",(0,r.jsxs)(s.p,{children:["We next see the use of ",(0,r.jsx)(s.code,{children:"newTempUserCtx"})," utility function. As mentioned before, we already have three users in our context, where they have the type ",(0,r.jsx)(s.code,{children:"User"}),":"]}),"\n",(0,r.jsx)(s.pre,{"data-language":"haskell","data-theme":"default",hasCopyCode:!0,children:(0,r.jsxs)(s.code,{"data-language":"haskell","data-theme":"default",children:[(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"data"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"User"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" User"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    { userSKey "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"::"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"!GYPaymentSigningKey"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    , userAddr "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"::"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"!GYAddress"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    , userColl "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"::"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"!GYTxOutRef"})]}),"\n",(0,r.jsx)(s.span,{className:"line",children:(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})})]})}),"\n",(0,r.jsxs)(o.UW,{type:"warning",emoji:"",children:[(0,r.jsxs)(s.p,{children:["We also have a type ",(0,r.jsx)(s.code,{children:"UserIdx"})," defined for these three users:"]}),(0,r.jsx)(s.pre,{"data-language":"haskell","data-theme":"default",hasCopyCode:!0,children:(0,r.jsxs)(s.code,{"data-language":"haskell","data-theme":"default",children:[(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"data"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"UserIdx"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" User1"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"|"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" User2"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"|"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" User3"})]})]})})]}),"\n",(0,r.jsxs)(s.p,{children:["But at rare times, we might need to create a new user. Such a user would not be part of the context and thus would be local to the test creating it",(0,r.jsx)(s.sup,{children:(0,r.jsx)(s.a,{href:"#user-content-fn-2",id:"user-content-fnref-2","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"3"})}),"."]}),"\n",(0,r.jsxs)(s.p,{children:["We can do that with the help of ",(0,r.jsx)(s.code,{children:"newTempUserCtx"})," function. It accepts the context parameter, the index for the user which will fund this new user and the value to be given to this new user. Note that internally it will create two UTxOs for this new user, where one would be for collateral and will take 5 ada from the given value."]}),"\n",(0,r.jsxs)(s.p,{children:["Next we see the use of ",(0,r.jsx)(s.code,{children:"getSlotAndConfig"})," function. Earlier when we wrote for PSM tests, we could work in absolute slots as we were always running each test from the beginning of ledger but this is not the case here. Thus, we would need to work with relative slots, i.e., we find the current slot and then add offset with respect to it. Function ",(0,r.jsx)(s.code,{children:"getSlotAndConfig"})," has the folowing definition:"]}),"\n",(0,r.jsx)(s.pre,{"data-language":"haskell","data-theme":"default",hasCopyCode:!0,children:(0,r.jsxs)(s.code,{"data-language":"haskell","data-theme":"default",children:[(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"getSlotAndConfig"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"::"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"Ctx"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"->"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"IO"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" ("}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"GYSlot"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"GYSlotConfig"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:")"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"getSlotAndConfig ctx "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"do"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  slot "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"<-"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" ctxCurrentSlot ctx"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  sc   "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"<-"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" ctxSlotConfig ctx"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  return (slot"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" sc)"})]})]})}),"\n",(0,r.jsxs)(s.p,{children:["Next we compute for our contract parameters and since we already obtained the slot config, we can use ",(0,r.jsx)(s.code,{children:"slotToBeginTimePure"})," instead of ",(0,r.jsx)(s.code,{children:"slotToBeginTime"}),"."]}),"\n",(0,r.jsxs)(s.p,{children:["We next see the use of ",(0,r.jsx)(s.code,{children:"ctxRunC"}),". To understand it, we need to first look at signature of ",(0,r.jsx)(s.code,{children:"ctxRunF"}),"."]}),"\n",(0,r.jsx)(s.pre,{"data-language":"haskell","data-theme":"default",hasCopyCode:!0,children:(0,r.jsx)(s.code,{"data-language":"haskell","data-theme":"default",children:(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"ctxRunF"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"::"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"forall"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" t v"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"."}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"Traversable"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" t "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"Ctx"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"->"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"UserIdx"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"->"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"ReaderT"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"GYCompiledScripts"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"GYTxMonadNode"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" (t ("}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"GYTxSkeleton"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" v)) "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"->"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"IO"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" (t "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"GYTxBody"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:")"})]})})}),"\n",(0,r.jsxs)(s.p,{children:["We see that it has a type variable ",(0,r.jsx)(s.code,{children:"t"})," which should have an instance of ",(0,r.jsx)(s.code,{children:"Traversable"}),". The other two functions, namely ",(0,r.jsx)(s.code,{children:"ctxRunC"})," & ",(0,r.jsx)(s.code,{children:"ctxRunI"})," call this ",(0,r.jsx)(s.code,{children:"ctxRunF"})," function with suitable instantiation of type variable ",(0,r.jsx)(s.code,{children:"t"}),"."]}),"\n",(0,r.jsxs)(s.p,{children:["Here is the table which explains about these three (",(0,r.jsx)(s.code,{children:"ctxRunF"}),", ",(0,r.jsx)(s.code,{children:"ctxRunC"})," & ",(0,r.jsx)(s.code,{children:"ctxRunI"}),") related functions:"]}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Function"}),(0,r.jsx)(s.th,{children:"When to use?"}),(0,r.jsx)(s.th,{children:"What does it do?"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"ctxRunI"})}),(0,r.jsxs)(s.td,{children:["When you want to build for single ",(0,r.jsx)(s.code,{children:"GYTxSkeleton"})]}),(0,r.jsxs)(s.td,{children:["It wraps our skeleton under ",(0,r.jsx)(s.code,{children:"Identity"}),(0,r.jsx)(s.sup,{children:(0,r.jsx)(s.a,{href:"#user-content-fn-3",id:"user-content-fnref-3","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"4"})}),", that is what suffix ",(0,r.jsx)(s.code,{children:"I"})," stands for"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"ctxRunF"})}),(0,r.jsxs)(s.td,{children:["When you have say multiple skeletons, like ",(0,r.jsx)(s.code,{children:"[GYTxSkeleton]"}),", or ",(0,r.jsx)(s.code,{children:"Maybe GYTxSkeleton"})]}),(0,r.jsx)(s.td,{children:"-"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"ctxRunC"})}),(0,r.jsxs)(s.td,{children:["When you don't want to build skeletons. This is in particular useful for operations like ",(0,r.jsx)(s.code,{children:"utxosAtAddress"})]}),(0,r.jsxs)(s.td,{children:["The type constructor ",(0,r.jsx)(s.code,{children:"Const"})," is defined as ",(0,r.jsx)(s.code,{children:"newtype Const a b = Const { getConst :: a }"})," and therefore type parameter ",(0,r.jsx)(s.code,{children:"b"})," is phantom and thus this function helps us ignore for ",(0,r.jsx)(s.code,{children:"GYTxSkeleton"})]})]})]})]}),"\n",(0,r.jsxs)(s.p,{children:["We next add for reference script using helper utility function ",(0,r.jsx)(s.code,{children:"addRefScriptCtx"}),"."]}),"\n",(0,r.jsxs)(s.p,{children:["We then start placing our bets, once we have the transaction body, we use ",(0,r.jsx)(s.code,{children:"findOutput"})," function which gives us the reference to the UTxO (the first one it finds",(0,r.jsx)(s.sup,{children:(0,r.jsx)(s.a,{href:"#user-content-fn-4",id:"user-content-fnref-4","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"5"})}),") that is being locked at the script address. We use ",(0,r.jsx)(s.code,{children:"threadDelay 1_000_000"})," to wait for one second so that our transaction is added to the blockchain."]}),"\n",(0,r.jsxs)(s.p,{children:["After placing our bets, we use ",(0,r.jsx)(s.code,{children:"ctxWaitUntilSlot"})," to wait till the unlock slot."]}),"\n",(0,r.jsxs)(s.p,{children:["We next add for our reference input using ",(0,r.jsx)(s.code,{children:"addRefInputCtx"})," helper utility function."]}),"\n",(0,r.jsxs)(s.p,{children:["Now before performing the unlock operation, we query the balance of unlocker so that we can compare with it later using ",(0,r.jsx)(s.code,{children:"ctxQueryBalance"})," function."]}),"\n",(0,r.jsxs)(s.p,{children:["Next we perform the unlock operation (calling our ",(0,r.jsx)(s.code,{children:"takeBets"})," operation)."]}),"\n",(0,r.jsx)(s.p,{children:"Lastly, we verify that the unlocker was able to take all the bets by comparing the balance."}),"\n",(0,r.jsxs)(o.UW,{children:[(0,r.jsxs)(s.p,{children:["There exists a helper function in ",(0,r.jsx)(s.a,{href:"https://github.com/geniusyield/atlas/tree/main/src/GeniusYield/Test/Privnet/Asserts.hs",children:(0,r.jsx)(s.code,{children:"Asserts.hs"})})," for what we did in the last step, i.e., to see that our expected value matches the actual considering fees, here is its definition:"]}),(0,r.jsx)(s.pre,{"data-language":"haskell","data-theme":"default",hasCopyCode:!0,children:(0,r.jsxs)(s.code,{"data-language":"haskell","data-theme":"default",children:[(0,r.jsx)(s.span,{className:"line",children:(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"{- Asserts if the user funds change as expected."})}),"\n",(0,r.jsx)(s.span,{className:"line",children:(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"   The `fees` argument is an estimation for the transaction fees."})}),"\n",(0,r.jsx)(s.span,{className:"line",children:(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"-}"})}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"assertUserFunds"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"::"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"Integer"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"->"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"Ctx"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"->"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"UserIdx"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"->"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"GYValue"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"->"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"IO"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"()"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"assertUserFunds fees ctx uid expectedValue "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"do"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    currentValue "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"<-"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" ctxQueryBalance ctx uid"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"let"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" (cLovelace"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" cAssets) "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" valueSplitAda currentValue"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        (eLovelace"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" eAssets) "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" valueSplitAda expectedValue"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    assertBool (unwords ["}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"The non-Ada token didn\'t change as expected"'}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"                         "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"\\nExpected: "'}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" show eAssets"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"                         "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"\\nCurrent: "'}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" show cAssets])"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"               (cAssets "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"=="}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" eAssets)"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    assertBool (unwords ["}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"The lovelaces didn\'t change as expected,"'}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"                         "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"\\nExpected: "'}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" show eLovelace"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"                         "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"\\nCurrent: "'}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" show cLovelace])"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"               ((cLovelace "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"+"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" fees "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:">="}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" eLovelace) "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"&&"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"                (cLovelace "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"<"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" eLovelace))"})]})]})})]}),"\n",(0,r.jsx)(s.h2,{id:"writing-a-failing-test",children:"Writing a failing test"}),"\n",(0,r.jsx)(s.p,{children:"Now let's see another test where we slightly modify the last step (all the rest is same) and this time we instead try to take funds by not the closest guesser."}),"\n",(0,r.jsx)(s.pre,{"data-language":"haskell","data-theme":"default",hasCopyCode:!0,children:(0,r.jsxs)(s.code,{"data-language":"haskell","data-theme":"default",children:[(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"-- Fourth step, get the bets pot."})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"--"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"-- Let's first wait for the required amount"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  ctxWaitUntilSlot ctx (unsafeAdvanceSlot currentSlot betRevealSlotDelta)  "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"-- here this `currentSlot` is what we obtained sometime ago, the actual current slot has certainly increased a lot by now."})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"--"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"-- Let's then add for the reference input"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  refInputORef "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"<-"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" addRefInputCtx ctx User1 True (userAddr oracleUser) (datumFromPlutusData (OracleAnswerDatum "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"2"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"))"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  threadDelay "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"1_000_000"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"--"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"-- Unlock operation"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"-- But this time by wrong guesser"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  assertThrown isTxBodyErrorAutoBalance "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"$"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" ctxRunI ctx User1 "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"$"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" takeBets refScript brp lockedORef (ctxUserAddr ctx User1) refInputORef"})]})]})}),"\n",(0,r.jsxs)(s.p,{children:["Notice that we try catching the error using ",(0,r.jsx)(s.code,{children:"assertThrown"})," function. Here ",(0,r.jsx)(s.code,{children:"isTxBodyErrorAutoBalance"})," is defined as (both this & ",(0,r.jsx)(s.code,{children:"assertThrown"})," have their definitions in ",(0,r.jsx)(s.a,{href:"https://github.com/geniusyield/atlas/tree/main/src/GeniusYield/Test/Privnet/Asserts.hs",children:(0,r.jsx)(s.code,{children:"Asserts.hs"})})," file):"]}),"\n",(0,r.jsx)(s.pre,{"data-language":"haskell","data-theme":"default",hasCopyCode:!0,children:(0,r.jsxs)(s.code,{"data-language":"haskell","data-theme":"default",children:[(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"isTxBodyErrorAutoBalance"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"::"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"BuildTxException"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"->"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"Bool"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"isTxBodyErrorAutoBalance (BuildTxBodyErrorAutoBalance _) "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" True"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"isTxBodyErrorAutoBalance _                               "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" False"})]})]})}),"\n",(0,r.jsxs)(s.p,{children:["Thus our ",(0,r.jsx)(s.code,{children:"assertThrown"})," function checks for two things:"]}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:"Whether our action indeed raises an exception."}),"\n",(0,r.jsxs)(s.li,{children:["If an exception is raised, does it saitsfy our predicate? For instance, here our predicate was ",(0,r.jsx)(s.code,{children:"isTxBodyErrorAutoBalance"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(o.UW,{children:[(0,r.jsxs)(s.p,{children:["You can also catch for ",(0,r.jsx)(s.code,{children:"IO"})," error like:"]}),(0,r.jsx)(s.pre,{"data-language":"haskell","data-theme":"default",hasCopyCode:!0,children:(0,r.jsxs)(s.code,{"data-language":"haskell","data-theme":"default",children:[(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  errored "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"<-"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" catchIOError (submitTx ctx User1 txBody "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:">>"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" pure False) ("}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"\\"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"_ "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"->"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" pure True)"})]}),"\n",(0,r.jsxs)(s.span,{className:"line",children:[(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"  unless errored "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"$"}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" assertFailure "}),(0,r.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"Expecting an IOError exception"'})]})]})})]}),"\n",(0,r.jsx)(s.p,{children:"With this we conclude upon writing integration tests."}),"\n",(0,r.jsxs)(s.section,{"data-footnotes":!0,className:"footnotes",children:[(0,r.jsx)(s.h2,{className:"sr-only",id:"footnote-label",children:"Footnotes"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{id:"user-content-fn-5",children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.a,{href:"https://unix.stackexchange.com/q/367008",children:"https://unix.stackexchange.com/q/367008"})," ",(0,r.jsx)(s.a,{href:"#user-content-fnref-5","data-footnote-backref":!0,className:"data-footnote-backref","aria-label":"Back to content",children:"↩"})]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{id:"user-content-fn-1",children:["\n",(0,r.jsxs)(s.p,{children:["For convenience, you can write a bash script which combines setup, running tests & closing the privnet all into one simple script. ",(0,r.jsx)(s.a,{href:"#user-content-fnref-1","data-footnote-backref":!0,className:"data-footnote-backref","aria-label":"Back to content",children:"↩"})]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{id:"user-content-fn-2",children:["\n",(0,r.jsxs)(s.p,{children:["Even though this user is local to the test which created it, it would still persist in our private network. ",(0,r.jsx)(s.a,{href:"#user-content-fnref-2","data-footnote-backref":!0,className:"data-footnote-backref","aria-label":"Back to content",children:"↩"})]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{id:"user-content-fn-3",children:["\n",(0,r.jsxs)(s.p,{children:["Technically, it's not wrapper that is happening place here but rather we coerce with ",(0,r.jsx)(s.code,{children:"Identity"})," newtype. ",(0,r.jsx)(s.a,{href:"#user-content-fnref-3","data-footnote-backref":!0,className:"data-footnote-backref","aria-label":"Back to content",children:"↩"})]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{id:"user-content-fn-4",children:["\n",(0,r.jsxs)(s.p,{children:["Therefore this function is intended to be used when we create only a single output for an external address. ",(0,r.jsx)(s.a,{href:"#user-content-fnref-4","data-footnote-backref":!0,className:"data-footnote-backref","aria-label":"Back to content",children:"↩"})]}),"\n"]}),"\n"]}),"\n"]})]})}e=n.hmd(e),(0,t.j)({Content:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:s}=Object.assign({},(0,i.ah)(),e.components);return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(c,{...e})}):c(e)},nextraLayout:o.ZP,hot:e.hot,pageOpts:{filePath:"src/pages/getting-started/integration-tests.mdx",route:"/getting-started/integration-tests",frontMatter:{},pageMap:[{kind:"Meta",data:{index:{title:"Atlas",display:"hidden",theme:{layout:"raw"}},documentation:{title:"Documentation",type:"page",href:"/introduction"},introduction:"Introduction","getting-started":"Getting Started"}},{kind:"Folder",name:"getting-started",route:"/getting-started",children:[{kind:"Meta",data:{"smart-contract-intro":"Smart Contract",operations:"Operations over Contract","unit-tests":"Unit Tests","integration-tests":"Integration Tests",endpoints:"Creating Endpoints","browser-integration":"Browser Integration"}},{kind:"MdxPage",name:"browser-integration",route:"/getting-started/browser-integration"},{kind:"MdxPage",name:"endpoints",route:"/getting-started/endpoints"},{kind:"MdxPage",name:"integration-tests",route:"/getting-started/integration-tests"},{kind:"MdxPage",name:"operations",route:"/getting-started/operations"},{kind:"MdxPage",name:"smart-contract-intro",route:"/getting-started/smart-contract-intro"},{kind:"MdxPage",name:"unit-tests",route:"/getting-started/unit-tests"}]},{kind:"MdxPage",name:"getting-started",route:"/getting-started"},{kind:"MdxPage",name:"index",route:"/"},{kind:"MdxPage",name:"introduction",route:"/introduction"}],headings:[{depth:1,value:"Integration Tests",id:"integration-tests"},{depth:2,value:"Spinning up private network",id:"spinning-up-private-network"},{depth:2,value:"Understanding our first test",id:"understanding-our-first-test"},{depth:2,value:"Writing a failing test",id:"writing-a-failing-test"}],flexsearch:{codeblocks:!0},title:"Integration Tests"},themeConfig:l.Z,pageNextRoute:"/getting-started/integration-tests",pageOptsChecksum:void 0,dynamicMetaModules:[]})}},function(e){e.O(0,[783,774,888,179],function(){return e(e.s=6975)}),_N_E=e.O()}]);